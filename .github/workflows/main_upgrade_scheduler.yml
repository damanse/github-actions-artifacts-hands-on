name: Main Upgrade Scheduler

on:
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to process'
        required: true
        type: string
        default: 'PG_256'
      start_time:
        description: 'Start of allowed time window (UTC HH:MM)'
        required: true
        default: '07:30'
      end_time:
        description: 'End of allowed time window (UTC HH:MM)'
        required: true
        default: '18:30'

jobs:
  # get-pods:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     matrix: ${{ steps.set-matrix.outputs.matrix }}
  #   steps:
  #     - name: Get pods (mock)
  #       id: set-matrix
  #       run: |
  #         # Replace this mock logic with your real pod/host generator
  #         POD_JSON='[{"pod":"251","hosts":["host1","host2","host3"]},{"pod":"288","hosts":["host100","host101","host102","host103","host104","host105"]}]'
  #         echo "matrix=$POD_JSON" >> $GITHUB_OUTPUT

  get-pods:
    runs-on: ubuntu-latest
    outputs:
      pod_json: ${{ steps.set-output.outputs.pod_json }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Ansible Playbook to Get Pods
        run: |
          ansible-playbook playbooks/get-pods.yml --extra-vars "site=${{ inputs.site }}"

      - name: Check if /tmp/pods.json exists
        run: |
          if [ -f /tmp/pods.json ]; then
            echo "File exists. Contents of /tmp/pods.json:"
            cat /tmp/pods.json
            echo "Formatting...."
            # sed -z 's/\s//g' /tmp/pods.json > /tmp/pods.min.json
            sed -z "s/\(\[\{.*\}\]\)/'\1'/g" /tmp/pods.json > /tmp/pods.min.json
            echo "Contents of /tmp/pods.min.json:"
            cat /tmp/pods.min.json
          else
            echo "File /tmp/pods.json does not exist."
          fi

      # - name: Set pod_json output
      #   id: set-output
      #   run: |
      #     POD_JSON=$(cat /tmp/pods.json)
      #     echo "pod_json=$POD_JSON" >> "$GITHUB_OUTPUT"
      #     rm -f /tmp/pods.json

      - name: Set pod_json output
        id: set-output
        run: |
          POD_JSON=$(cat /tmp/pods.min.json)
          echo "::set-output name=pod_json::$POD_JSON"

  debug-pod-json:
    runs-on: ubuntu-latest
    needs: get-pods
    steps:
      - name: Debug pod_json
        run: |
          echo "pod_json: ${{ needs.get-pods.outputs.pod_json }}"



  run-pods:
    needs: get-pods
    strategy:
      matrix:
        pod_group: ${{ fromJson(needs.get-pods.outputs.pod_json) }}
      fail-fast: false
    uses: ./.github/workflows/pod_upgrade_handler.yml
    with:
      pod: ${{ matrix.pod }}
      hosts: ${{ toJson(matrix.hosts) }}
      start_time: ${{ inputs.start_time }}
      end_time: ${{ inputs.end_time }}
