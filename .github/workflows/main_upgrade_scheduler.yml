name: Main Upgrade Scheduler

on:
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to process'
        required: true
        type: string
      start_time:
        description: 'Start of allowed time window (UTC HH:MM)'
        required: true
        default: '10:30'
      end_time:
        description: 'End of allowed time window (UTC HH:MM)'
        required: true
        default: '11:30'

jobs:
  # get-pods:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     matrix: ${{ steps.set-matrix.outputs.pod_json }}
  #   steps:
  #     - name: Get pods (mock)
  #       id: set-matrix
  #       run: |
  #         # Replace this mock logic with your real pod/host generator
  #         POD_JSON='[{"pod":"251","hosts":["host1","host2","host3"]},{"pod":"288","hosts":["host100","host101","host102","host103","host104","host105"]}]'
  #         echo "matrix=$POD_JSON" >> $GITHUB_OUTPUT

  get-pods:
    runs-on: ubuntu-latest
    outputs:
      pod_json: ${{ steps.set-output.outputs.pod_json }}

    steps:
      - name: 🧰 Checkout repo
        uses: actions/checkout@v4

      - name: 🛠️ Run Ansible Playbook to Generate pod_output.json
        run: |
          echo "Running Ansible playbook with site=${{ inputs.site }}"
          ansible-playbook playbooks/get-pods.yml \
            --extra-vars "site=${{ inputs.site }}"

      - name: 📦 Set pod_json output and clean up
        id: set-output
        run: |
          POD_JSON=$(cat /tmp/pod_output.json)
          echo "pod_json=$POD_JSON" >> "$GITHUB_OUTPUT"
          rm -f /tmp/pod_output.json

  run-pods:
    needs: get-pods
    strategy:
      matrix:
        include: ${{ fromJson(needs.get-pods.outputs.pod_json) }}
      fail-fast: false
    uses: ./.github/workflows/pod_upgrade_handler.yml
    with:
      pod: ${{ matrix.pod }}
      hosts: ${{ toJson(matrix.hosts) }}
      start_time: ${{ inputs.start_time }}
      end_time: ${{ inputs.end_time }}
