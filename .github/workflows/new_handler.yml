name: Handle Pod

on:
  workflow_call:
    inputs:
      pod:
        required: true
        type: string
      hosts:
        required: true
        type: string
      start_time:
        required: true
        type: string
      end_time:
        required: true
        type: string

jobs:
  upgrade-hosts:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      max-parallel: 1
      matrix:
        host: ${{ fromJson(inputs.hosts) }}
    name: Pod ${{ inputs.pod }} - Host ${{ matrix.host }}
    steps:
      # - name: Check time window
      #   uses: ./.github/actions/time-window-check
      #   with:
      #     start_time: ${{ inputs.start_time }}
      #     end_time: ${{ inputs.end_time }}

      # - name: Install Ansible
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y ansible

      - name: Run Upgrade on ${{ matrix.host }}
        id: upgrade
        run: |
          echo "Running upgrade script on ${{ matrix.host }}"
          echo "Checking Start and End time ${{ inputs.start_time }} - ${{ inputs.end_time }}"
          echo "Checking Big Red Button..."
          echo "Starting upgrade..."

          python3 <<EOF
          import subprocess
          import time
          import sys
          
          host = "${{ matrix.host }}"
          max_attempts = 3
          sleep_seconds = 5
          
          for attempt in range(1, max_attempts + 1):
              print(f"🔁 Attempt {attempt} of {max_attempts} for host: {host}")
          
              try:
                  # result = subprocess.run([
                  #     "ansible-playbook",
                  #     "upgrade-playbook.yml",
                  #     "--extra-vars", f"target_host={host}"
                  # ], check=True)
                  
                  time.sleep(30)
                  
                  print(f"✅ Upgrade succeeded on attempt {attempt}")
                  sys.exit(0)
          
              except subprocess.CalledProcessError as e:
                  print(f"❌ Playbook failed on attempt {attempt} with code {e.returncode}")
                  if attempt < max_attempts:
                      print(f"⏳ Retrying in {sleep_seconds} seconds...")
                      time.sleep(sleep_seconds)
                  else:
                      print("🔥 Upgrade failed after all retries.")
                      sys.exit(1)
          EOF
